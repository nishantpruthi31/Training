{"cells":[{"cell_type":"code","execution_count":1,"metadata":{"id":"VgLhn5ATVIKk","executionInfo":{"status":"ok","timestamp":1704965251561,"user_tz":-330,"elapsed":124789,"user":{"displayName":"Nishant Pruthi","userId":"05492412063404871418"}}},"outputs":[],"source":["%%capture\n","\n","!apt-get update\n","!apt-get install -y openjdk-8-jdk-headless -qq\n","!apt-get install maven -qq\n","\n","!curl -L \"https://archive.apache.org/dist/spark/spark-2.4.5/spark-2.4.5-bin-hadoop2.7.tgz\" > spark-2.4.5-bin-hadoop2.7.tgz\n","!tar -xvf spark-2.4.5-bin-hadoop2.7.tgz\n","!pip install -q findspark\n","!pip install pyspark py4j\n","from pyspark.sql import SparkSession\n","from pyspark.sql.functions import when\n","from pyspark.sql import functions\n","from pyspark.sql.types import IntegerType\n","from pyspark.sql.functions import col\n","#from pyspark.sql.Column import isNull\n","from pyspark.sql.functions import lit\n","spark = SparkSession.builder.master(\"local[*]\").config(\"spark.driver.memory\", \"16g\").getOrCreate()"]},{"cell_type":"code","execution_count":2,"metadata":{"id":"YV12JxkFfpQs","executionInfo":{"status":"ok","timestamp":1704965915319,"user_tz":-330,"elapsed":2717,"user":{"displayName":"Nishant Pruthi","userId":"05492412063404871418"}}},"outputs":[],"source":["\n","from pyspark.sql import SparkSession\n","spark=SparkSession.builder.appName(\"Collaborative filtering\").getOrCreate()\n","\n","# from pyspark.sql.functions import col,lit\n","# from pyspark.sql.functions import sum,avg,max,min,mean,count\n","\n"]},{"cell_type":"code","execution_count":3,"metadata":{"id":"cFxQ13UZpVJw","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1704966014087,"user_tz":-330,"elapsed":11889,"user":{"displayName":"Nishant Pruthi","userId":"05492412063404871418"}},"outputId":"dbaf7b66-e5ad-4088-97b2-5632a264ee5f"},"outputs":[{"output_type":"stream","name":"stdout","text":["+-------+--------------------+--------------------+\n","|movieId|               title|              genres|\n","+-------+--------------------+--------------------+\n","|      1|    Toy Story (1995)|Adventure|Animati...|\n","|      2|      Jumanji (1995)|Adventure|Childre...|\n","|      3|Grumpier Old Men ...|      Comedy|Romance|\n","|      4|Waiting to Exhale...|Comedy|Drama|Romance|\n","|      5|Father of the Bri...|              Comedy|\n","|      6|         Heat (1995)|Action|Crime|Thri...|\n","|      7|      Sabrina (1995)|      Comedy|Romance|\n","|      8| Tom and Huck (1995)|  Adventure|Children|\n","|      9| Sudden Death (1995)|              Action|\n","|     10|    GoldenEye (1995)|Action|Adventure|...|\n","|     11|American Presiden...|Comedy|Drama|Romance|\n","|     12|Dracula: Dead and...|       Comedy|Horror|\n","|     13|        Balto (1995)|Adventure|Animati...|\n","|     14|        Nixon (1995)|               Drama|\n","|     15|Cutthroat Island ...|Action|Adventure|...|\n","|     16|       Casino (1995)|         Crime|Drama|\n","|     17|Sense and Sensibi...|       Drama|Romance|\n","|     18|   Four Rooms (1995)|              Comedy|\n","|     19|Ace Ventura: When...|              Comedy|\n","|     20|  Money Train (1995)|Action|Comedy|Cri...|\n","+-------+--------------------+--------------------+\n","only showing top 20 rows\n","\n","+------+-------+------+---------+\n","|userId|movieId|rating|timestamp|\n","+------+-------+------+---------+\n","|     1|      1|   4.0|964982703|\n","|     1|      3|   4.0|964981247|\n","|     1|      6|   4.0|964982224|\n","|     1|     47|   5.0|964983815|\n","|     1|     50|   5.0|964982931|\n","|     1|     70|   3.0|964982400|\n","|     1|    101|   5.0|964980868|\n","|     1|    110|   4.0|964982176|\n","|     1|    151|   5.0|964984041|\n","|     1|    157|   5.0|964984100|\n","|     1|    163|   5.0|964983650|\n","|     1|    216|   5.0|964981208|\n","|     1|    223|   3.0|964980985|\n","|     1|    231|   5.0|964981179|\n","|     1|    235|   4.0|964980908|\n","|     1|    260|   5.0|964981680|\n","|     1|    296|   3.0|964982967|\n","|     1|    316|   3.0|964982310|\n","|     1|    333|   5.0|964981179|\n","|     1|    349|   4.0|964982563|\n","+------+-------+------+---------+\n","only showing top 20 rows\n","\n"]}],"source":["moviesDF=spark.read.options(header='True',inferSchema='True').csv('movies.csv')\n","ratingsDF=spark.read.options(header='True',inferSchema='True').csv('ratings.csv')\n","\n","moviesDF.show()\n","ratingsDF.show()\n"]},{"cell_type":"code","execution_count":7,"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":35},"executionInfo":{"elapsed":9,"status":"ok","timestamp":1704966158079,"user":{"displayName":"Nishant Pruthi","userId":"05492412063404871418"},"user_tz":-330},"id":"MAWrez_8eM06","outputId":"75e3d304-73af-40ad-c287-a256ac7825a6"},"outputs":[{"output_type":"display_data","data":{"text/plain":["DataFrame[movieId: int, title: string, genres: string]"]},"metadata":{}}],"source":["# join dataframes\n","\n","display(moviesDF)    # to get a better view"]},{"cell_type":"code","source":["ratingsDF.join(moviesDF,\"movieid\",\"left\").show()   # left join i.e. left table is  ratings"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"EAwguUjR5vFw","executionInfo":{"status":"ok","timestamp":1704966359794,"user_tz":-330,"elapsed":1442,"user":{"displayName":"Nishant Pruthi","userId":"05492412063404871418"}},"outputId":"4b184114-7393-404d-cdbf-83aa4be81a75"},"execution_count":8,"outputs":[{"output_type":"stream","name":"stdout","text":["+-------+------+------+---------+--------------------+--------------------+\n","|movieId|userId|rating|timestamp|               title|              genres|\n","+-------+------+------+---------+--------------------+--------------------+\n","|      1|     1|   4.0|964982703|    Toy Story (1995)|Adventure|Animati...|\n","|      3|     1|   4.0|964981247|Grumpier Old Men ...|      Comedy|Romance|\n","|      6|     1|   4.0|964982224|         Heat (1995)|Action|Crime|Thri...|\n","|     47|     1|   5.0|964983815|Seven (a.k.a. Se7...|    Mystery|Thriller|\n","|     50|     1|   5.0|964982931|Usual Suspects, T...|Crime|Mystery|Thr...|\n","|     70|     1|   3.0|964982400|From Dusk Till Da...|Action|Comedy|Hor...|\n","|    101|     1|   5.0|964980868|Bottle Rocket (1996)|Adventure|Comedy|...|\n","|    110|     1|   4.0|964982176|   Braveheart (1995)|    Action|Drama|War|\n","|    151|     1|   5.0|964984041|      Rob Roy (1995)|Action|Drama|Roma...|\n","|    157|     1|   5.0|964984100|Canadian Bacon (1...|          Comedy|War|\n","|    163|     1|   5.0|964983650|    Desperado (1995)|Action|Romance|We...|\n","|    216|     1|   5.0|964981208|Billy Madison (1995)|              Comedy|\n","|    223|     1|   3.0|964980985|       Clerks (1994)|              Comedy|\n","|    231|     1|   5.0|964981179|Dumb & Dumber (Du...|    Adventure|Comedy|\n","|    235|     1|   4.0|964980908|      Ed Wood (1994)|        Comedy|Drama|\n","|    260|     1|   5.0|964981680|Star Wars: Episod...|Action|Adventure|...|\n","|    296|     1|   3.0|964982967| Pulp Fiction (1994)|Comedy|Crime|Dram...|\n","|    316|     1|   3.0|964982310|     Stargate (1994)|Action|Adventure|...|\n","|    333|     1|   5.0|964981179|    Tommy Boy (1995)|              Comedy|\n","|    349|     1|   4.0|964982563|Clear and Present...|Action|Crime|Dram...|\n","+-------+------+------+---------+--------------------+--------------------+\n","only showing top 20 rows\n","\n"]}]},{"cell_type":"code","source":["ratings=ratingsDF.join(moviesDF,\"movieid\",\"left\")  # stroing in variable\n","(train,test)=ratings.randomSplit([0.8,0.2])   # 80% for training , 20% for testing , this will return 2 df"],"metadata":{"id":"2jOGKbQB6gHL","executionInfo":{"status":"ok","timestamp":1704967235282,"user_tz":-330,"elapsed":474,"user":{"displayName":"Nishant Pruthi","userId":"05492412063404871418"}}},"execution_count":10,"outputs":[]},{"cell_type":"code","source":["train.show()"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"MVsLioce9cYA","executionInfo":{"status":"ok","timestamp":1704967246267,"user_tz":-330,"elapsed":2559,"user":{"displayName":"Nishant Pruthi","userId":"05492412063404871418"}},"outputId":"24a9edac-30ba-422c-8cee-892f85f18015"},"execution_count":11,"outputs":[{"output_type":"stream","name":"stdout","text":["+-------+------+------+----------+----------------+--------------------+\n","|movieId|userId|rating| timestamp|           title|              genres|\n","+-------+------+------+----------+----------------+--------------------+\n","|      1|     1|   4.0| 964982703|Toy Story (1995)|Adventure|Animati...|\n","|      1|     5|   4.0| 847434962|Toy Story (1995)|Adventure|Animati...|\n","|      1|     7|   4.5|1106635946|Toy Story (1995)|Adventure|Animati...|\n","|      1|    15|   2.5|1510577970|Toy Story (1995)|Adventure|Animati...|\n","|      1|    17|   4.5|1305696483|Toy Story (1995)|Adventure|Animati...|\n","|      1|    18|   3.5|1455209816|Toy Story (1995)|Adventure|Animati...|\n","|      1|    19|   4.0| 965705637|Toy Story (1995)|Adventure|Animati...|\n","|      1|    31|   5.0| 850466616|Toy Story (1995)|Adventure|Animati...|\n","|      1|    32|   3.0| 856736119|Toy Story (1995)|Adventure|Animati...|\n","|      1|    33|   3.0| 939647444|Toy Story (1995)|Adventure|Animati...|\n","|      1|    40|   5.0| 832058959|Toy Story (1995)|Adventure|Animati...|\n","|      1|    43|   5.0| 848993983|Toy Story (1995)|Adventure|Animati...|\n","|      1|    45|   4.0| 951170182|Toy Story (1995)|Adventure|Animati...|\n","|      1|    50|   3.0|1514238116|Toy Story (1995)|Adventure|Animati...|\n","|      1|    54|   3.0| 830247330|Toy Story (1995)|Adventure|Animati...|\n","|      1|    57|   5.0| 965796031|Toy Story (1995)|Adventure|Animati...|\n","|      1|    63|   5.0|1443199669|Toy Story (1995)|Adventure|Animati...|\n","|      1|    64|   4.0|1161520134|Toy Story (1995)|Adventure|Animati...|\n","|      1|    76|   0.5|1439165548|Toy Story (1995)|Adventure|Animati...|\n","|      1|    82|   2.5|1084467729|Toy Story (1995)|Adventure|Animati...|\n","+-------+------+------+----------+----------------+--------------------+\n","only showing top 20 rows\n","\n"]}]},{"cell_type":"code","source":["# creating ALS Model\n","\n","from pyspark.ml.recommendation import ALS\n","\n","als=ALS(userCol=\"userId\",itemCol=\"movieId\",ratingCol=\"rating\",nonnegative=True,implicitPrefs=False,coldStartStrategy=\"drop\")\n","# userCol me , kisko recomend krna\n","# itemCol m , kya recomend krne\n","#nonnegative ko true because ratings are +ve\n","#implicitprefs m false because we using explicit\n","#coldstartstrategy means drop those users who not take part in ratings"],"metadata":{"id":"GNW2FEp494Fp","executionInfo":{"status":"ok","timestamp":1704967633312,"user_tz":-330,"elapsed":13,"user":{"displayName":"Nishant Pruthi","userId":"05492412063404871418"}}},"execution_count":12,"outputs":[]},{"cell_type":"code","source":["# Hypertuning and cross validation (AI related - multiple models)\n","\n","from pyspark.ml.evaluation import RegressionEvaluator\n","from pyspark.ml.tuning import ParamGridBuilder , CrossValidator"],"metadata":{"id":"_EFq-w0e_XN2","executionInfo":{"status":"ok","timestamp":1704967886374,"user_tz":-330,"elapsed":8,"user":{"displayName":"Nishant Pruthi","userId":"05492412063404871418"}}},"execution_count":13,"outputs":[]},{"cell_type":"code","source":["# creating models\n","\n","param_grid = ParamGridBuilder() \\\n","            .addGrid(als.rank, [10, 50, 100, 150]) \\\n","            .addGrid(als.regParam, [.01, .05, .1, .15]) \\\n","            .build()\n","           # 16 models will be created i.e. 4*4"],"metadata":{"id":"NeTTJvb3AVAC","executionInfo":{"status":"ok","timestamp":1704968147900,"user_tz":-330,"elapsed":506,"user":{"displayName":"Nishant Pruthi","userId":"05492412063404871418"}}},"execution_count":16,"outputs":[]},{"cell_type":"code","source":["# evaluator\n","\n","evaluator = RegressionEvaluator(\n","           metricName=\"rmse\",\n","           labelCol=\"rating\",\n","           predictionCol=\"prediction\")"],"metadata":{"id":"l8QDz7SXBCyg","executionInfo":{"status":"ok","timestamp":1704968209894,"user_tz":-330,"elapsed":8,"user":{"displayName":"Nishant Pruthi","userId":"05492412063404871418"}}},"execution_count":17,"outputs":[]},{"cell_type":"code","source":["# cross validator will give us best model\n","\n","cv = CrossValidator(estimator=als, estimatorParamMaps=param_grid, evaluator=evaluator, numFolds=5)  # numFolds=5 , to eptimize to 5 times"],"metadata":{"id":"Lguf-vEKBj-7","executionInfo":{"status":"ok","timestamp":1704968275202,"user_tz":-330,"elapsed":8,"user":{"displayName":"Nishant Pruthi","userId":"05492412063404871418"}}},"execution_count":18,"outputs":[]},{"cell_type":"code","source":["model=cv.fit(train)    # model with data\n","bestModel=model.bestModel\n","\n","\n","testPrediction=bestModel.transform(test)\n","RMSE=evaluator(testPrediction)\n","print(RMSE)    # to get accuracy percentage of prediction"],"metadata":{"id":"Jt7rVIiBBz7m"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["# oral only\n","\n","recommendations = best_model.recommendForAllUsers(5)\n","\n","# COMMAND ----------\n","\n","df = recommendations\n","\n","# COMMAND ----------\n","\n","display(df)\n","\n","# COMMAND ----------\n","\n","df2 = df.withColumn(\"movieid_rating\", explode(\"recommendations\"))\n","\n","# COMMAND ----------\n","\n","display(df2)\n","\n","# COMMAND ----------\n","\n","display(df2.select(\"userId\", col(\"movieid_rating.movieId\"), col(\"movieid_rating.rating\")))\n","\n","# COMMAND ----------\n"],"metadata":{"id":"av8hYfoPCp-W"},"execution_count":null,"outputs":[]}],"metadata":{"colab":{"provenance":[{"file_id":"11YM-lleSvtN7VXzuep2XS63Vi7Wta6I6","timestamp":1704978369224},{"file_id":"1yaR5AnPIUKlGbxaBCFaqGOibqyzKSsaE","timestamp":1703061654276},{"file_id":"/v2/external/notebooks/intro.ipynb","timestamp":1703060626608}]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}